generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  telegramId   String?  @unique
  username     String?  @unique
  displayName  String
  language     String?
  createdAt    DateTime @default(now())
  profile      Profile?
  reportsSent  Report[] @relation("reportsSent")
  reportsRecv  Report[] @relation("reportsRecv")
  blocksSent   Block[]  @relation("blocksSent")
  blocksRecv   Block[]  @relation("blocksRecv")
  events       Event[]  @relation("eventsOrganizer")
  likesFrom    Like[]   @relation("likesFrom")
  likesTo      Like[]   @relation("likesTo")
  matchesA     Match[]  @relation("matchesA")
  matchesB     Match[]  @relation("matchesB")
  messagesSent Message[] @relation("messagesSent")
  messagesRecv Message[] @relation("messagesRecv")
}

model Profile {
  id             String           @id @default(cuid())
  user           User             @relation(fields: [userId], references: [id])
  userId         String           @unique
  pronouns       String?
  gender         String?
  genderCustom   String?
  orientations   Orientation[]    @relation("ProfileOrientations")
  privacy        PrivacySettings?
  intentsFriends Boolean          @default(false)
  intentsRomance Boolean          @default(false)
  intentsPoly    Boolean          @default(false)
  transInclusive Boolean          @default(true)
  verified       Verification?
  moderation     ModerationFlags?
  city           String?
  latitude       Float?
  longitude      Float?
  geoHash        String?
  locationUpdatedAt DateTime?
  @@index([latitude])
  @@index([longitude])
  @@index([locationUpdatedAt])
}

model Orientation {
  id    String   @id @default(cuid())
  name  String   @unique
  users Profile[] @relation("ProfileOrientations")
}

model PrivacySettings {
  id             String  @id @default(cuid())
  profile        Profile @relation(fields: [profileId], references: [id])
  profileId      String  @unique
  incognito      Boolean @default(false)
  hideDistance   Boolean @default(false)
  profileVisible Boolean @default(true)
  mapConsent     Boolean @default(false)
  mapConsentAt   DateTime?
}

model Verification {
  id             String   @id @default(cuid())
  profile        Profile  @relation(fields: [profileId], references: [id])
  profileId      String   @unique
  photoVerified  Boolean  @default(false)
  selfieVerified Boolean  @default(false)
  idVerified     Boolean  @default(false)
  updatedAt      DateTime @updatedAt
}

model ModerationFlags {
  id             String   @id @default(cuid())
  profile        Profile  @relation(fields: [profileId], references: [id])
  profileId      String   @unique
  flagged        Boolean  @default(false)
  reason         String?
  updatedAt      DateTime @updatedAt
}

model Report {
  id          String   @id @default(cuid())
  reporter    User     @relation("reportsSent", fields: [reporterId], references: [id])
  reporterId  String
  reported    User     @relation("reportsRecv", fields: [reportedId], references: [id])
  reportedId  String
  reason      String
  createdAt   DateTime @default(now())
}

model Block {
  id          String   @id @default(cuid())
  blocker     User     @relation("blocksSent", fields: [blockerId], references: [id])
  blockerId   String
  blocked     User     @relation("blocksRecv", fields: [blockedId], references: [id])
  blockedId   String
  createdAt   DateTime @default(now())
  @@unique([blockerId, blockedId])
}

model Event {
  id          String   @id @default(cuid())
  organizer   User     @relation("eventsOrganizer", fields: [organizerId], references: [id])
  organizerId String
  title       String
  description String?
  location    String?
  startsAt    DateTime
  endsAt      DateTime?
  createdAt   DateTime @default(now())
}

model Like {
  id        String   @id @default(cuid())
  from      User     @relation("likesFrom", fields: [fromId], references: [id])
  fromId    String
  to        User     @relation("likesTo", fields: [toId], references: [id])
  toId      String
  createdAt DateTime @default(now())
  @@unique([fromId, toId])
}

model Match {
  id        String   @id @default(cuid())
  a         User     @relation("matchesA", fields: [aId], references: [id])
  aId       String
  b         User     @relation("matchesB", fields: [bId], references: [id])
  bId       String
  createdAt DateTime @default(now())
  @@unique([aId, bId])
}

model Message {
  id          String   @id @default(cuid())
  sender      User     @relation("messagesSent", fields: [senderId], references: [id])
  senderId    String
  recipient   User     @relation("messagesRecv", fields: [recipientId], references: [id])
  recipientId String
  content     String
  createdAt   DateTime @default(now())
  read        Boolean  @default(false)
  deliveredAt DateTime?
  readAt      DateTime?
  messageType MessageType @default(TEXT)
  mediaUrl    String?
  mediaMime   String?
  mediaSize   Int?

  @@index([recipientId, readAt])
  @@index([senderId, recipientId, createdAt])
  @@index([recipientId, createdAt])
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
}

model Stats {
  id        String   @id @default(cuid())
  day       DateTime @unique
  likes     Int      @default(0)
  matches   Int      @default(0)
  messages  Int      @default(0)
}
